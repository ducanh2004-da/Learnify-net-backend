using Microsoft.EntityFrameworkCore;
using Learnify.Repository.Models;
using Learnify.Common.Enums;
using Npgsql.EntityFrameworkCore.PostgreSQL.Infrastructure;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;

namespace Learnify.Repository.Data
{
    public class AppDbContext : DbContext
    {
        public AppDbContext(DbContextOptions<AppDbContext> options) : base(options) { }

        public DbSet<User> Users { get; set; }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);

            // Register Postgres enum with explicit labels in the same order/names as the database
            modelBuilder.HasPostgresEnum<Role>("Role", "INSTRUCTOR", "USER", "REVIEWER", "ADMIN");

            modelBuilder.Entity<User>(entity =>
            {
                entity.ToTable("User");

                // Map tất cả columns theo Prisma (lowercase)
                entity.HasKey(e => e.Id);
                entity.Property(e => e.Id).HasColumnName("id");
                entity.Property(e => e.Username).HasColumnName("username");
                entity.Property(e => e.Email).HasColumnName("email");
                entity.Property(e => e.Password).HasColumnName("password");
                entity.Property(e => e.GoogleId).HasColumnName("googleId");
                entity.Property(e => e.PhoneNumber).HasColumnName("phoneNumber");
                entity.Property(e => e.Address).HasColumnName("address");

                // Ensure Role property uses the PostgreSQL enum type; Npgsql will map the C# enum to DB enum
                entity.Property(e => e.Role)
                      .HasColumnName("role")
                      .HasColumnType("Role");

                entity.Property(e => e.HashedRefreshToken).HasColumnName("hashedRefreshToken");
                entity.Property(e => e.Avatar).HasColumnName("avatar");
                entity.Property(e => e.CreatedAt).HasColumnName("createdAt");
                entity.Property(e => e.UpdatedAt).HasColumnName("updatedAt");

                entity.HasIndex(e => e.Email).IsUnique();
                entity.Property(e => e.Email).IsRequired();
            });
        }
    }
}